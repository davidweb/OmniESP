<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniESP OS V2 - Industriel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 20px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 45px; height: 45px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; }
        .logo-text h1 { font-size: 22px; color: #2d3748; font-weight: 700; }
        .logo-text p { font-size: 11px; color: #718096; margin-top: 2px; }
        .status-badge { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: #d4edda; border-radius: 20px; font-size: 13px; font-weight: 600; color: #155724; }
        .status-dot { width: 8px; height: 8px; background: #28a745; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .tabs { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); display: flex; max-width: 1400px; margin: 20px auto; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: 600; font-size: 15px; color: #718096; background: transparent; border: none; transition: all 0.3s ease; position: relative; }
        .tab:hover { background: rgba(102, 126, 234, 0.1); color: #667eea; }
        .tab.active { color: #667eea; background: rgba(102, 126, 234, 0.15); }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #667eea, #764ba2); }
        .content { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; }
        .content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 16px; font-weight: 600; color: #2d3748; }
        .card-icon { width: 35px; height: 35px; border-radius: 10px; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; }
        .card-value { font-size: 28px; font-weight: 700; color: #667eea; margin: 10px 0; min-height: 40px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;}
        .card-unit { font-size: 16px; color: #718096; font-weight: 500; }
        .card-secondary { font-size: 13px; color: #a0aec0; margin-top: 5px; }
        .btn-control { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-on { background: linear-gradient(135deg, #48bb78, #38a169); color: white; box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3); }
        .btn-on:hover { transform: scale(1.02); box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4); }
        .btn-off { background: linear-gradient(135deg, #cbd5e0, #a0aec0); color: #4a5568; }
        .btn-off:hover { background: linear-gradient(135deg, #e2e8f0, #cbd5e0); transform: scale(1.02); }
        .slider-container { margin-top: 10px; }
        .slider { width: 100%; height: 8px; border-radius: 5px; background: #e2e8f0; outline: none; -webkit-appearance: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); cursor: pointer; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4); }
        .form-container { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        .form-title { font-size: 20px; font-weight: 700; color: #2d3748; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: #4a5568; margin-bottom: 8px; }
        .form-input, .form-select { width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; background: white; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); margin-top: 30px; }
        .device-list { margin-top: 30px; }
        .device-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f7fafc; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #667eea; }
        .device-info { flex: 1; }
        .device-name { font-weight: 600; color: #2d3748; font-size: 15px; }
        .device-details { font-size: 12px; color: #718096; margin-top: 3px; }
        .btn-delete { padding: 8px 16px; background: #fc8181; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .empty-state { text-align: center; padding: 60px 20px; color: #a0aec0; }
        
        /* V2 Styles */
        .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        .stat-item { background: #f7fafc; padding: 8px; border-radius: 8px; text-align: center; }
        .stat-val { font-weight: 700; color: #4a5568; font-size: 14px; }
        .stat-lbl { font-size: 10px; color: #a0aec0; text-transform: uppercase; }
        .scan-group { display: flex; gap: 10px; align-items: flex-end; }
        .btn-scan { background: #ecc94b; color: #744210; padding: 12px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .btn-scan:hover { background: #d69e2e; }
        .i2c-result { margin-top: 10px; background: #fffbe5; border: 1px solid #ecc94b; padding: 10px; border-radius: 8px; display: none; }
        .i2c-item { display: flex; justify-content: space-between; padding: 6px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
        .i2c-item:hover { background: rgba(0,0,0,0.05); }
        .i2c-badge { background: #ecc94b; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        .input-group { display: flex; gap: 5px; margin-top: 10px; }
        .lcd-input { flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; }
        .btn-mini { padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üè≠</div>
                <div class="logo-text">
                    <h1>OmniESP OS</h1>
                    <p>Ghemrielec ‚Ä¢ V2 Industrial</p>
                </div>
            </div>
            <div class="status-badge"><span class="status-dot"></span>Syst√®me Online</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="setTab('dash')">üìä Tableau de Bord</button>
        <button class="tab" onclick="setTab('cfg')">‚öôÔ∏è Configuration</button>
    </div>

    <div id="dash" class="content active">
        <div id="grid" class="grid"></div>
    </div>

    <div id="cfg" class="content">
        <div class="form-container">
            <h3 class="form-title">‚ûï Ajouter un Composant</h3>
            
            <div class="form-group">
                <label class="form-label">Type de Composant</label>
                <select id="type" class="form-select" onchange="checkI2C()">
                    <optgroup label="üè≠ Industriel I2C (V2)">
                        <option value="INA219">Moniteur √ânergie (INA219)</option>
                        <option value="BME280">M√©t√©o Pr√©cision (BME280)</option>
                        <option value="BH1750">Luxm√®tre (BH1750)</option>
                        <option value="LCD_I2C">√âcran LCD 1602/2004</option>
                        <option value="OLED">√âcran OLED SSD1306 (0.96")</option>
                    </optgroup>
                    <optgroup label="üîå Actionneurs">
                        <option value="RELAY">Relais / Prise / Lampe</option>
                        <option value="VALVE">√âlectrovanne</option>
                        <option value="LOCK">Serrure √âlectrique</option>
                        <option value="SERVO">Servo Moteur</option>
                        <option value="NEOPIXEL">Ruban LED (NeoPixel)</option>
                    </optgroup>
                    <optgroup label="üì° Capteurs">
                        <option value="DHT22">Temp/Hum (DHT22)</option>
                        <option value="DHT11">Temp/Hum (DHT11)</option>
                        <option value="DS18B20">Temp √âtanche (Sonde)</option>
                        <option value="PIR">D√©tecteur Mouvement</option>
                        <option value="DOOR">Capteur Porte/Fen√™tre</option>
                        <option value="BUTTON">Bouton Poussoir</option>
                        <option value="MQ2">D√©tecteur Gaz (MQ2)</option>
                        <option value="SOIL">Humidit√© Sol</option>
                        <option value="LDR">Luminosit√© Analog</option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Nom du Composant</label>
                <input type="text" id="name" class="form-input" placeholder="Ex: Salon">
            </div>

            <div class="form-group">
                <label class="form-label" id="pin-label">Pin GPIO (ESP32)</label>
                <div class="scan-group">
                    <select id="pin" class="form-select">
                        <option value="-1">-- S√©lectionner --</option>
                        <optgroup label="I2C Adresses (Scanner pour d√©tecter)">
                            <option value="0x27">0x27 (39) - LCD Default</option>
                            <option value="0x3C">0x3C (60) - OLED Default</option>
                            <option value="0x40">0x40 (64) - INA219 Default</option>
                            <option value="0x76">0x76 (118) - BME280 Default</option>
                            <option value="0x23">0x23 (35) - BH1750 Default</option>
                        </optgroup>
                        <optgroup label="GPIO Standard">
                            <option value="23">GPIO 23</option>
                            <option value="19">GPIO 19</option>
                            <option value="18">GPIO 18</option>
                            <option value="5">GPIO 5</option>
                            <option value="4">GPIO 4</option>
                            <option value="2">GPIO 2</option>
                            <option value="13">GPIO 13</option>
                            <option value="12">GPIO 12</option>
                            <option value="14">GPIO 14</option>
                            <option value="27">GPIO 27</option>
                            <option value="26">GPIO 26</option>
                            <option value="34">GPIO 34 (IN ONLY)</option>
                            <option value="35">GPIO 35 (IN ONLY)</option>
                            <option value="36">GPIO 36 (IN ONLY)</option>
                            <option value="39">GPIO 39 (IN ONLY)</option>
                        </optgroup>
                    </select>
                    <button class="btn-scan" id="scanBtn" onclick="runScan()">üîç Scan I2C</button>
                </div>
                <div id="scanRes" class="i2c-result"><div id="scanList"></div></div>
            </div>

            <button class="btn-primary" onclick="add()">Ajouter le Composant</button>

            <div class="device-list">
                <h3 class="form-title">üìã Composants Configur√©s</h3>
                <div id="list"></div>
            </div>
            <button class="btn-primary btn-success" onclick="save()">üíæ Sauvegarder & Red√©marrer</button>
        </div>
    </div>

    <script>
        let devices = [];
        const ws = new WebSocket(`ws://${location.hostname}/ws`);
        
        function setTab(id) {
            document.querySelectorAll('.content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        async function refresh() {
            try {
                const res = await fetch('/api/status');
                const d = await res.json();
                devices = d.devices;
                renderDash();
                renderList();
            } catch(e) { console.error(e); }
        }

        function checkI2C() {
            const t = document.getElementById('type').value;
            const isI2C = ['INA219', 'BME280', 'BH1750', 'LCD_I2C', 'OLED'].includes(t);
            document.getElementById('pin-label').innerText = isI2C ? "Adresse I2C" : "Pin GPIO";
            document.getElementById('scanBtn').style.display = isI2C ? "block" : "none";
        }

        async function runScan() {
            const btn = document.getElementById('scanBtn');
            const resDiv = document.getElementById('scanRes');
            const listDiv = document.getElementById('scanList');
            
            btn.innerText = "‚è≥...";
            try {
                const r = await fetch('/api/scan');
                const d = await r.json();
                const found = d.i2c_devices || [];
                
                resDiv.style.display = 'block';
                listDiv.innerHTML = found.length ? found.map(f => `
                    <div class="i2c-item" onclick="selectAddr('${f.addr_hex}')">
                        <span>${f.addr_hex} (${f.addr_dec})</span>
                        <span class="i2c-badge">${f.hint}</span>
                    </div>
                `).join('') : '<div style="padding:5px; color:#666">Rien trouv√©</div>';
                
            } catch(e) { alert('Erreur Scan'); }
            btn.innerText = "üîç Scan I2C";
        }

        function selectAddr(hex) {
            const dec = parseInt(hex, 16);
            const sel = document.getElementById('pin');
            let opt = Array.from(sel.options).find(o => parseInt(o.value) === dec);
            if(!opt) { opt = new Option(`${hex} (${dec}) - D√©tect√©`, dec); sel.add(opt); }
            sel.value = dec;
            document.getElementById('scanRes').style.display = 'none';
        }

        function formatValue(val) { return (typeof val === 'number') ? val.toFixed(2) : val; }

        function getIcon(driver) {
            const icons = {
                'RELAY': 'üí°', 'VALVE': 'üíß', 'LOCK': 'üîí', 'SERVO': 'üîß', 'NEOPIXEL': 'üåà',
                'DHT22': 'üå°Ô∏è', 'DHT11': 'üå°Ô∏è', 'DS18B20': 'üå°Ô∏è', 'PIR': 'üëÅÔ∏è', 'DOOR': 'üö™',
                'BUTTON': 'üîò', 'MQ2': 'üí®', 'SOIL': 'üå±', 'LDR': '‚òÄÔ∏è',
                'INA219': '‚ö°', 'BME280': 'üå§Ô∏è', 'BH1750': 'üí°', 'LCD_I2C': 'üìü', 'OLED': 'üñ•Ô∏è'
            };
            return icons[driver] || 'üì¶';
        }

        function renderDash() {
            const grid = document.getElementById('grid');
            if (devices.length === 0) { grid.innerHTML = `<div class="empty-state"><h3>Aucun composant</h3></div>`; return; }

            grid.innerHTML = devices.map(d => {
                const icon = getIcon(d.driver);
                let inner = '';
                
                if(['RELAY', 'VALVE', 'LOCK'].includes(d.driver)) {
                    const on = d.val.val === 1;
                    inner = `<button class="btn-control ${on ? 'btn-on' : 'btn-off'}" onclick="cmd('${d.id}', 'toggle')">${on ? '‚úì ACTIF' : '‚óã INACTIF'}</button>`;
                } else if(d.driver === 'SERVO') {
                    inner = `<div class="card-value">${d.val.angle || 0}<span class="card-unit">¬∞</span></div>
                             <div class="slider-container"><input type="range" class="slider" min="0" max="180" value="${d.val.angle||0}" onchange="cmd('${d.id}','set',this.value)"></div>`;
                } else if(d.driver === 'INA219') {
                    inner = `<div class="card-value">${formatValue(d.val.mW)} <span class="card-unit">mW</span></div>
                        <div class="grid-stats"><div class="stat-item"><div class="stat-val">${formatValue(d.val.volts)}V</div><div class="stat-lbl">Tension</div></div>
                        <div class="stat-item"><div class="stat-val">${formatValue(d.val.mA)}mA</div><div class="stat-lbl">Courant</div></div></div>`;
                } else if(d.driver === 'BME280') {
                    inner = `<div class="card-value">${formatValue(d.val.temp)} <span class="card-unit">¬∞C</span></div>
                        <div class="grid-stats"><div class="stat-item"><div class="stat-val">${formatValue(d.val.hum)}%</div><div class="stat-lbl">Humidit√©</div></div>
                        <div class="stat-item"><div class="stat-val">${Math.round(d.val.pres)}</div><div class="stat-lbl">hPa</div></div></div>`;
                } else if(d.driver === 'LCD_I2C' || d.driver === 'OLED') {
                    inner = `<div class="card-secondary" style="margin-bottom:5px">Message:</div>
                        <div style="background:#2d3748; color:#48bb78; padding:8px; font-family:monospace; border-radius:4px; margin-bottom:10px; font-size:12px; overflow:hidden">${d.val.display || '...'}</div>
                        <div class="input-group"><input type="text" id="txt_${d.id}" class="lcd-input" placeholder="Message..."><button class="btn-mini" onclick="sendText('${d.id}')">Envoyer</button></div>`;
                } else if(d.val.temp !== undefined) {
                    inner = `<div class="card-value">${formatValue(d.val.temp)}<span class="card-unit">¬∞C</span></div>${d.val.hum ? `<div class="card-secondary">Humidit√©: ${formatValue(d.val.hum)}%</div>` : ''}`;
                } else {
                    const first = Object.values(d.val)[0];
                    inner = `<div class="card-value">${first !== undefined ? formatValue(first) : '--'}</div>`;
                }
                
                return `<div class="card"><div class="card-header"><span class="card-title">${d.name}</span><div class="card-icon">${icon}</div></div>${inner}</div>`;
            }).join('');
        }

        function renderList() {
            const list = document.getElementById('list');
            if (devices.length === 0) { list.innerHTML = `<div class="empty-state"><p>Vide</p></div>`; return; }
            list.innerHTML = devices.map((d, i) => {
                const isI2C = ['INA219','BME280','BH1750','LCD_I2C','OLED'].includes(d.driver);
                const pinDisplay = isI2C ? `Addr 0x${d.pin.toString(16).toUpperCase()}` : `GPIO ${d.pin}`;
                return `<div class="device-item"><div class="device-info"><div class="device-name">${getIcon(d.driver)} ${d.name}</div>
                        <div class="device-details">${d.driver} ‚Ä¢ ${pinDisplay}</div></div><button class="btn-delete" onclick="del(${i})">‚úï</button></div>`;
            }).join('');
        }

        function add() {
            const t = document.getElementById('type').value;
            const n = document.getElementById('name').value.trim();
            const p = parseInt(document.getElementById('pin').value);
            if(!n || p === -1) { alert('‚ö†Ô∏è Nom ou Pin invalide'); return; }
            if(devices.find(d => d.pin === p)) { alert('‚ö†Ô∏è Pin/Adresse d√©j√† utilis√©'); return; }
            devices.push({ id: t.toLowerCase()+'_'+p, driver: t, name: n, pin: p });
            document.getElementById('name').value = '';
            renderList();
        }
        
        function del(i) { if(confirm('Supprimer ?')) { devices.splice(i, 1); renderList(); } }
        
        async function save() {
            if(!confirm('Sauvegarder et Red√©marrer ?')) return;
            try { await fetch('/api/config', { method: 'POST', body: JSON.stringify({devices}) }); alert('‚úÖ Sauvegard√© !'); setTimeout(() => location.reload(), 4000); } catch(e) { alert('Erreur'); }
        }

        function cmd(id, c, v = 0) { fetch(`/api/control?id=${id}&cmd=${c}&val=${v}`, {method: 'POST'}).catch(console.error); }
        function sendText(id) { const txt = document.getElementById('txt_'+id).value; if(!txt) return; fetch(`/api/control?id=${id}&text=${encodeURIComponent(txt)}`, {method: 'POST'}).then(() => document.getElementById('txt_'+id).value = ''); }

        ws.onmessage = (e) => { try { const data = JSON.parse(e.data); data.devices.forEach(nd => { const od = devices.find(x => x.id === nd.id); if(od) od.val = nd.val; }); renderDash(); } catch(e) {} }
        ws.onclose = () => setTimeout(() => location.reload(), 5000);

        checkI2C(); refresh();
    </script>
</body>
</html>