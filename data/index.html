<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniESP Manager</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; color: #444; }
        header { background: #2c3e50; color: white; padding: 15px; text-align: center; font-size: 1.2rem; }
        .tabs { display: flex; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: #3498db; color: #3498db; }
        .content { padding: 20px; display: none; }
        .content.active { display: block; }

        /* Dashboard Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .card { background: white; border-radius: 10px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .val { font-size: 1.4rem; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .btn-act { width: 100%; padding: 10px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .on { background: #2ecc71; color: white; } .off { background: #e74c3c; color: white; }

        /* Config Form */
        .form-box { background: white; padding: 20px; border-radius: 10px; }
        select, input, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .list-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; }
    </style>
</head>
<body>
    <header>âš¡ MAISON INTELLIGENTE</header>
    <div class="tabs">
        <div class="tab active" onclick="setTab('dash')">Tableau de Bord</div>
        <div class="tab" onclick="setTab('cfg')">Configuration</div>
    </div>

    <!-- DASHBOARD -->
    <div id="dash" class="content active">
        <div id="grid" class="grid"></div>
    </div>

    <!-- CONFIG -->
    <div id="cfg" class="content">
        <div class="form-box">
            <h3>Ajouter un Composant</h3>
            
            <label>Type de Composant</label>
            <select id="type">
                <optgroup label="Actionneurs (Sorties)">
                    <option value="RELAY">Relais / Prise / Lampe</option>
                    <option value="VALVE">Ã‰lectrovanne (Arrosage)</option>
                    <option value="LOCK">Serrure Ã‰lectrique</option>
                    <option value="SERVO">Servo Moteur</option>
                    <option value="NEOPIXEL">Ruban LED (NeoPixel)</option>
                </optgroup>
                <optgroup label="Capteurs (EntrÃ©es)">
                    <option value="DHT22">Temp/Hum (DHT22)</option>
                    <option value="DHT11">Temp/Hum (DHT11)</option>
                    <option value="DS18B20">Temp Ã‰tanche (Sonde)</option>
                    <option value="PIR">DÃ©tecteur Mouvement</option>
                    <option value="DOOR">Capteur Porte/FenÃªtre</option>
                    <option value="BUTTON">Bouton Poussoir</option>
                    <option value="MQ2">DÃ©tecteur Gaz (MQ2)</option>
                    <option value="SOIL">HumiditÃ© Sol</option>
                    <option value="LDR">LuminositÃ©</option>
                </optgroup>
            </select>

            <label>Nom (ex: Garage)</label>
            <input type="text" id="name" placeholder="Nom...">

            <label>PIN (ESP32)</label>
            <select id="pin">
                <option value="23">GPIO 23 (I/O)</option>
                <option value="22">GPIO 22 (I/O)</option>
                <option value="21">GPIO 21 (I/O)</option>
                <option value="19">GPIO 19 (I/O)</option>
                <option value="18">GPIO 18 (I/O)</option>
                <option value="5">GPIO 5 (I/O)</option>
                <option value="4">GPIO 4 (I/O)</option>
                <option value="2">GPIO 2 (LED Carte)</option>
                <option value="13">GPIO 13 (I/O)</option>
                <option value="12">GPIO 12 (I/O)</option>
                <option value="14">GPIO 14 (I/O)</option>
                <option value="27">GPIO 27 (I/O)</option>
                <option value="26">GPIO 26 (I/O)</option>
                <option value="34">GPIO 34 (INPUT ONLY !)</option>
                <option value="35">GPIO 35 (INPUT ONLY !)</option>
                <option value="36">GPIO 36 (INPUT ONLY !)</option>
                <option value="39">GPIO 39 (INPUT ONLY !)</option>
            </select>

            <button onclick="add()" style="background:#3498db; color:white">AJOUTER</button>
            <hr>
            <h3>Liste Actuelle</h3>
            <div id="list"></div>
            <button onclick="save()" style="background:#2ecc71; color:white; margin-top:20px">ðŸ’¾ SAUVEGARDER & REDÃ‰MARRER</button>
        </div>
    </div>

    <script>
        let devices = [];
        const ws = new WebSocket(`ws://${location.hostname}/ws`);
        
        // --- LOGIC ---
        function setTab(id) {
            document.querySelectorAll('.content').forEach(d=>d.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        async function refresh() {
            const res = await fetch('/api/status');
            const d = await res.json();
            devices = d.devices;
            renderDash();
            renderList();
        }

        function renderDash() {
            document.getElementById('grid').innerHTML = devices.map(d => {
                let inner = '';
                // Rendu intelligent selon type
                if(d.driver === 'RELAY' || d.driver === 'VALVE' || d.driver === 'LOCK') {
                    const on = d.val.val === 1;
                    inner = `<button class="btn-act ${on?'on':'off'}" onclick="cmd('${d.id}', 'toggle')">${on?'ON':'OFF'}</button>`;
                } else if(d.driver === 'SERVO') {
                     inner = `<input type="range" min="0" max="180" onchange="cmd('${d.id}','set',this.value)">`;
                } else {
                    // Capteurs
                    inner = `<div class="val">${Object.values(d.val)[0]}</div>`;
                    if(d.val.temp) inner = `<div class="val">${d.val.temp}Â°C <small>${d.val.hum}%</small></div>`;
                }
                return `<div class="card"><strong>${d.name}</strong>${inner}</div>`;
            }).join('');
        }

        function renderList() {
            document.getElementById('list').innerHTML = devices.map((d,i) => `
                <div class="list-item">
                    <span><b>${d.name}</b> (${d.driver} @ G${d.pin})</span>
                    <button style="width:auto;padding:5px;background:#e74c3c;color:white" onclick="del(${i})">X</button>
                </div>
            `).join('');
        }

        // --- ACTIONS ---
        function add() {
            const t = document.getElementById('type').value;
            const n = document.getElementById('name').value;
            const p = parseInt(document.getElementById('pin').value);
            if(!n) return alert('Nom requis');
            devices.push({id: t.toLowerCase()+'_'+p, driver: t, name: n, pin: p});
            renderList();
        }
        
        function del(i) { devices.splice(i,1); renderList(); }
        
        async function save() {
            if(!confirm('Sauvegarder ?')) return;
            await fetch('/api/config', { method:'POST', body: JSON.stringify({devices}) });
            alert('SauvegardÃ©. RedÃ©marrage...');
        }

        function cmd(id, c, v=0) { fetch(`/api/control?id=${id}&cmd=${c}&val=${v}`, {method:'POST'}); }

        ws.onmessage = (e) => { 
            const data = JSON.parse(e.data);
            // Update simple: map les nouvelles valeurs sur les objets locaux
            data.devices.forEach(nd => {
                const od = devices.find(x => x.id === nd.id);
                if(od) od.val = nd.val;
            });
            renderDash();
        }

        refresh();
    </script>
</body>
</html>
